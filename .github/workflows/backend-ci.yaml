name: Backend CI Workflow

on:
  workflow_dispatch:
  push:
    paths:
      - 'backend/**'
    branches:       
      - main
  pull_request:
    paths:
      - 'backend/**'  
    branches: 
      - main

jobs:
  LINT:
    runs-on: ubuntu-latest
    steps:
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          cd starter/backend 
          python -m pip install --upgrade pip setuptools wheel
          pip install pipenv       
      - name: Debug information
        run: |
          pwd
          ls -la
          cat Pipfile
      - name: Install project dependencies
        run: |
          cd starter/backend
          pipenv install --dev
      - name: Run lint
        run: |
          cd starter/backend
          pipenv --venv
          pipenv run which flake8
          pipenv run lint

  TEST:
    runs-on: ubuntu-latest
    steps:
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies 
        run: |
          cd starter/backend        
          python -m pip install --upgrade pip setuptools wheel        
          pip install pipenv
      - name: Install project dependencies
        run: |
          cd starter/backend
          pipenv install --dev         
      - name: Run tests
        run: |
          cd starter/backend
          pipenv run test

  BUILD:
    needs: [LINT, TEST]
    runs-on: ubuntu-latest
    steps:
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          cd starter/backend
          python -m pip install --upgrade pip setuptools wheel
          pip install pipenv
          pipenv install --dev
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action
